name: Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.12.0'

      - name: Configure AWS credentials
        if: contains(github.event.inputs.environment, 'aws') || github.event_name == 'release'
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Update kubeconfig for EKS
        if: contains(github.event.inputs.environment, 'aws') || github.event_name == 'release'
        run: |
          aws eks update-kubeconfig --region ${{ vars.AWS_REGION || 'us-east-1' }} --name ${{ vars.EKS_CLUSTER_NAME }}

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image tag
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy API to Kubernetes
        run: |
          helm upgrade --install face-recognition-api ./infra/k8s/helm/api \
            --namespace face-recognition-${{ github.event.inputs.environment || 'prod' }} \
            --create-namespace \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api \
            --set image.tag=${{ steps.tag.outputs.tag }} \
            --set environment=${{ github.event.inputs.environment || 'production' }} \
            --wait --timeout=600s

      - name: Deploy Web to Kubernetes
        run: |
          helm upgrade --install face-recognition-web ./infra/k8s/helm/web \
            --namespace face-recognition-${{ github.event.inputs.environment || 'prod' }} \
            --create-namespace \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/web \
            --set image.tag=${{ steps.tag.outputs.tag }} \
            --set environment=${{ github.event.inputs.environment || 'production' }} \
            --wait --timeout=600s

      - name: Run database migrations
        run: |
          kubectl run migration-${{ github.run_id }} \
            --namespace face-recognition-${{ github.event.inputs.environment || 'prod' }} \
            --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:${{ steps.tag.outputs.tag }} \
            --rm -it --restart=Never \
            --command -- alembic upgrade head

      - name: Verify deployment
        run: |
          kubectl wait --for=condition=ready pod \
            --selector=app=face-recognition-api \
            --namespace face-recognition-${{ github.event.inputs.environment || 'prod' }} \
            --timeout=300s
          
          kubectl wait --for=condition=ready pod \
            --selector=app=face-recognition-web \
            --namespace face-recognition-${{ github.event.inputs.environment || 'prod' }} \
            --timeout=300s

      - name: Run smoke tests
        run: |
          API_URL=$(kubectl get service face-recognition-api \
            --namespace face-recognition-${{ github.event.inputs.environment || 'prod' }} \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' || echo "localhost")
          
          # Wait for service to be ready
          sleep 30
          
          # Test API health endpoint
          curl -f http://$API_URL/health || exit 1
          
          # Test API version endpoint
          curl -f http://$API_URL/v1/health || exit 1

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Notify Slack on success
        if: needs.deploy.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            üöÄ Deployment successful to ${{ github.event.inputs.environment || 'production' }}
            Version: ${{ github.event.release.tag_name || github.sha }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on failure
        if: needs.deploy.result == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            ‚ùå Deployment failed to ${{ github.event.inputs.environment || 'production' }}
            Version: ${{ github.event.release.tag_name || github.sha }}
            Please check the logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}