# Daily Log - 2025-09-07

## Tasks Completed âœ…
- Time: 45m â€¢ Status: Completed
- Description: Fixed manual image upload flow so detected faces are saved with visit snapshots and optional customer gallery images.
- Key Activities:
  - Reviewed `apps/web/src/components/ImageUploadModal.tsx` and API flow (`/v1/events/process-images`).
  - Audited `FaceMatchingService` and identified missing upload of cropped face bytes for visits.
  - Implemented upload of manual cropped face bytes to MinIO (faces-derived) and set `Visit.image_path` using `visits-faces/...` path.
  - Relaxed gallery save gating at API call-site (service still enforces threshold), and propagated `manual_upload` metadata to gallery service.
- Impact:
  - Visits created from manual uploads now include an image snapshot.
  - Customer galleries can store manual faces when service threshold permits; metadata distinguishes manual vs worker sources.
- Files Modified:
  - `apps/api/app/services/face_service.py`

## Tasks In Progress ðŸ”„
- None (awaiting validation on UI list showing visit images; optional tests to be added).

## Notes & Insights ðŸ’¡
- The API previously only attempted a synthetic fallback crop, skipping upload of the actual cropped face from manual uploads. That caused empty visit images.
- Visit listing already supports `visits-faces/` prefix mapped to `faces-derived`; aligned new upload path with this contract.
- Customer gallery saving threshold is controlled by `MIN_FACE_CONFIDENCE_TO_SAVE` (default 0.7). If manual uploads often fall below this, consider lowering via env for manual ingestion sessions.

## Tomorrow's Priorities ðŸ“‹
- Add unit tests for `FaceMatchingService._create_visit_record` ensuring manual face bytes are uploaded and `image_path` set.
- Add integration test hitting `/v1/events/process-images` that asserts non-empty `image_path` in created visit and gallery image count increments when allowed by threshold.
- Verify MinIO presign in visits list returns a valid URL for `visits-faces/...` objects.
