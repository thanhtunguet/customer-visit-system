# Daily Log â€” 2025-09-08

- Tasks Completed âœ…
  - Time: ~2h
  - Status: Completed
  - Description: Identity assignment/clustering tuning to reduce over-segmentation; reconciliation job.
  - Key Activities:
    - Added env-configurable knobs in config: EMBEDDING_DISTANCE_THR, MERGE_DISTANCE_THR, MERGE_MARGIN, MIN_CLUSTER_SAMPLES, MIN_TRACK_LENGTH, TEMPORAL_HYSTERESIS_SECS, QUALITY_MIN_SCORE.
    - Updated FaceMatchingService: two-threshold decision (search vs merge), margin-based assignment, temporal hysteresis cache per camera, cluster gating (min samples) to delay new customer creation, quality gate.
    - Added /v1/customers/reconcile endpoint to safely deduplicate existing customers via Milvus similarity + merge.
    - Wrote unit tests for low-quality rejection and soft-threshold margin assignment favoring known customer.
  - Impact:
    - Same-person faces more likely to coalesce; fewer spurious new customers.
    - Operators can tune behavior via environment without code changes.
    - Idempotent reconciliation path to clean historical over-segmentation.
  - Files Modified:
    - apps/api/app/core/config.py
    - apps/api/app/services/face_service.py
    - apps/api/app/routers/customers.py
    - apps/api/tests/test_face_identity_tuning.py (new)

- Tasks In Progress ðŸ”„
  - Consider persistent cache or track IDs from worker for stronger temporal smoothing.
  - Evaluate reconciliation batching and conflict handling on large datasets.

- Notes & Insights ðŸ’¡
  - API lacks explicit track_id; approximated temporal smoothing via per-camera recent assignment cache.
  - Cluster gating defers creation when MIN_CLUSTER_SAMPLES>1; defaults keep current behavior (1) to avoid regressions.
  - Reconciliation reuses merge logic to preserve images/embeddings and references.

- Tomorrow's Priorities ðŸ“‹
  - Expand tests: different-people similar features, varying lighting/angles (mocked embeddings), hysteresis behavior.
  - Optional: migrate merge logic into a service module for reuse by reconcile.
  - Expose knobs in web admin UI.
