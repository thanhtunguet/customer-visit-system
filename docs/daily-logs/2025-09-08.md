# Daily Log â€” 2025-09-08

- Tasks Completed âœ…
  - Time: ~1h
  - Status: Completed
  - Description: Implemented atomic Customer merge to delete secondary record, reassign all references, deduplicate face images, and rebuild Milvus embeddings.
  - Key Activities:
    - Refactored `/v1/customers/merge` to use a single DB transaction (async with begin).
    - Reassigned `visits.person_id` and `customer_face_images.customer_id` from secondary â†’ primary.
    - Deduplicated gallery by `image_hash` (kept best by confidence+quality).
    - Deleted secondary `customers` row.
    - Recomputed primary stats from `visits`.
    - Rebuilt Milvus embeddings from gallery and visits (best-effort).
    - Added idempotent handling when secondary already missing or when IDs are identical (no-op).
  - Impact:
    - Ensures only the primary Customer remains after merge.
    - Preserves and consolidates images/embeddings without duplicates.
    - Maintains referential integrity across tables.
  - Files Modified:
    - `apps/api/app/routers/customers.py`

- Tasks In Progress ðŸ”„
  - Verify vector index/caches hooks across services (Milvus rebuild path coverage)
  - Minimal audit logs present (logger). Consider DB-backed audit if required.

- Notes & Insights ðŸ’¡
  - Current architecture keeps embeddings in Milvus; canonical sources in DB are `customer_face_images.embedding` and `visits.face_embedding`.
  - Dedup via `image_hash` is reliable for gallery; visit embeddings dedup by SHA-256 of vector content.
  - RLS maintained via `SET app.tenant_id` before ops.

- Tomorrow's Priorities ðŸ“‹
  - Add unit tests for merge idempotency, FK reassignment, and dedup selection.
  - Consider extracting merge logic into a service for reuse + testing.
  - Optional: add DB audit table + event emitter for merges.
