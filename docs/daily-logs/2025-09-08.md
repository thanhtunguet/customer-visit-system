# Daily Log - 2025-09-08

- Tasks Completed âœ…
  - Time: ~45 min
  - Status: Completed
  - Description: Increased customer face gallery size and added visit merge capability.
  - Key Activities:
    - Raised default `MAX_FACE_IMAGES` from 5 to 12 and wired through settings.
    - Implemented `POST /v1/visits/merge` to consolidate multiple visits into a single record.
    - Reassign `CustomerFaceImage.visit_id` to primary visit during merge.
    - Aggregated visit fields (first/last seen, duration, counts, confidence).
    - Cleaned up MinIO images for deleted visits (best-effort).
    - Recomputed customer stats after merge.
  - Impact:
    - Enables larger per-customer face galleries for better recognition quality.
    - Reduces fragmentation by consolidating multiple visit detections into a single visit session.
  - Files Modified:
    - apps/api/app/core/config.py
    - apps/api/.env.example
    - apps/api/app/routers/events.py
    - apps/web/src/services/api.ts
    - apps/web/src/pages/Visits.tsx

- Tasks In Progress ðŸ”„
  - None (session scope changes completed)

- Notes & Insights ðŸ’¡
  - Visit merge enforces same tenant, same person, and same site for safety.
  - Chose primary visit by highest confidence (tie: earliest first_seen) when not specified.
  - Kept embeddings handling minimal due to current Milvus schema lacking visit_id indexing.
  - Customer gallery limit surfaces via `/v1/customers/{id}/face-gallery-stats` as `gallery_limit`.

- Tomorrow's Priorities ðŸ“‹
  - Consider adding frontend controls for visit merge and bulk selection.
  - Add unit tests for `/v1/visits/merge` success and validation errors.
  - Evaluate including visit_id in Milvus schema to enable precise embedding cleanup.
