# Daily Log â€” 2025-09-05

## Tasks Completed âœ…
- 10:15 â€” Fixed WebRTC auto-connect sequencing
  - Status: Done
  - Description: Ensured signaling WebSocket is fully open before starting a WebRTC session; created a deterministic start order.
  - Impact: Eliminates initial connection failure requiring manual stop/start.
  - Files Modified: `apps/web/src/components/WebRTCCameraStream.tsx`
- 10:28 â€” Replaced state with refs for ICE routing
  - Status: Done
  - Description: Switched `workerId` from React state to `useRef` to avoid stale closures in ICE candidate handlers.
  - Impact: Prevents ICE candidates from being sent to wrong `to_id`, improving connectivity.
  - Files Modified: `apps/web/src/components/WebRTCCameraStream.tsx`
- 10:36 â€” Adopted typed API methods and robust stop/start
  - Status: Done
  - Description: Replaced raw `apiClient.post` with `startWebRTCSession`/`stopWebRTCSession`; added full restart path for manual reconnect.
  - Impact: Fixes reconnect button behavior; aligns with typed client and consistent response handling.
  - Files Modified: `apps/web/src/components/WebRTCCameraStream.tsx`
- 10:44 â€” Improved video rendering and browser compatibility
  - Status: Done
  - Description: Always render video element, call `play()` on metadata, add `recvonly` transceiver for broader browser support.
  - Impact: Addresses black screen caused by rendering gating and negotiation issues.
  - Files Modified: `apps/web/src/components/WebRTCCameraStream.tsx`
- 11:12 â€” Wire worker camera assignment to actual capture
  - Status: Done
  - Description: Implemented camera assignment/release callbacks in worker to start/stop OpenCV capture; provided camera config to WebRTC streamer for on-demand start when a stream-request arrives.
  - Impact: Ensures frames exist for WebRTC track; should eliminate persistent black frames.
  - Files Modified: `apps/worker/app/main.py`, `apps/worker/app/webrtc_streamer.py`
- 11:24 â€” Ensure camera stream lifecycle around WebRTC
  - Status: Done
  - Description: On WebRTC start, call `POST /sites/{site}/cameras/{id}/stream/start`; on stop, call `/stream/stop`.
  - Impact: Guarantees worker assignment and capture before offer; releases camera when done.
  - Files Modified: `apps/web/src/components/WebRTCCameraStream.tsx`

## Tasks In Progress ðŸ”„
- Validate first-connection success and visible frames across browsers.

## Notes & Insights ðŸ’¡
- Root causes: (1) signaling race; (2) camera not actually capturing; (3) client hiding video before track. Addressed all three.
- If still black, next likely issue is codec mismatch (Safari prefers H264). We can filter SDP to prefer H264 in aiortc if needed.

## Tomorrow's Priorities ðŸ“‹
- Verify on Chrome and Safari. If Safari black, force H264 in worker SDP.
- Add health/status to UI for assigned camera and last frame timestamp from worker.
